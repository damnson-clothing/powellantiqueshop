# üöÄ Complete Deployment Guide - Powell's Antique Shop

## Table of Contents
1. [System Architecture Overview](#system-architecture-overview)
2. [Technology Stack](#technology-stack)
3. [Deployment Issues & Solutions](#deployment-issues--solutions)
4. [Step-by-Step Deployment](#step-by-step-deployment)
5. [Environment Variables](#environment-variables)
6. [Database Setup](#database-setup)
7. [Post-Deployment Checklist](#post-deployment-checklist)
8. [Troubleshooting](#troubleshooting)

---

## System Architecture Overview

### Application Structure
```
Powell's Antique Shop (Nuxt 3 Full-Stack E-commerce)
‚îÇ
‚îú‚îÄ‚îÄ Frontend (Vue 3 + SSR)
‚îÇ   ‚îú‚îÄ‚îÄ Public Pages (Products, Cart, Checkout)
‚îÇ   ‚îú‚îÄ‚îÄ Admin Panel (Products, Orders, Categories, Dashboard)
‚îÇ   ‚îî‚îÄ‚îÄ State Management (Pinia)
‚îÇ
‚îú‚îÄ‚îÄ Backend (Nitro Serverless Engine)
‚îÇ   ‚îú‚îÄ‚îÄ REST API Endpoints (/api/*)
‚îÇ   ‚îú‚îÄ‚îÄ Authentication (JWT + HTTP-only Cookies)
‚îÇ   ‚îú‚îÄ‚îÄ Database Layer (Prisma ORM)
‚îÇ   ‚îî‚îÄ‚îÄ Image Processing (Base64 encoding)
‚îÇ
‚îî‚îÄ‚îÄ Database (PostgreSQL via Neon)
    ‚îú‚îÄ‚îÄ Products (with images, pricing, inventory)
    ‚îú‚îÄ‚îÄ Categories (hierarchical)
    ‚îú‚îÄ‚îÄ Orders (with order items)
    ‚îî‚îÄ‚îÄ Admins (authentication)
```

### Deployment Platform
- **Hosting**: Vercel (Serverless Edge Functions)
- **Database**: Neon PostgreSQL (Serverless)
- **CDN**: Vercel Edge Network (Automatic)
- **SSL**: Auto-provisioned by Vercel

---

## Technology Stack

### Core Framework
- **Nuxt 3** (v3.21.0) - Full-stack Vue framework with SSR
- **Nitro** (v2.13.1) - Server engine (preset: vercel)
- **Vue 3** (v3.5.27) - Progressive JavaScript framework
- **Vite** (v7.3.1) - Build tool and dev server

### Backend & Database
- **Prisma ORM** (v5.18.0) - Type-safe database client
- **PostgreSQL** - Primary database (via Neon)
- **Zod** (v3.23.8) - Schema validation for all API endpoints

### Authentication & Security
- **jose** (v5.2.3) - JWT generation and verification (ESM-native, serverless-optimized)
- **bcrypt** (v5.1.1) - Password hashing (10 rounds)
- **HTTP-only cookies** - Secure token storage

### UI & Styling
- **Tailwind CSS** (v3.4.3) - Utility-first CSS framework
- **@nuxtjs/tailwindcss** (v6.12.0) - Nuxt Tailwind integration
- **@nuxt/image** (v1.7.0) - Image optimization

### State Management
- **Pinia** (v2.3.1) - Vue store (cart, product state)

---

## Deployment Issues & Solutions

### Critical Issue #1: JWT Library Incompatibility ‚ö†Ô∏è

**Problem:**
```
Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'jsonwebtoken' 
imported from /var/task/index.mjs
```

**Root Cause:**
- Original implementation used `jsonwebtoken` (CommonJS module)
- Nitro's Vercel preset produces ESM bundles (`.mjs` files)
- CommonJS modules don't bundle properly for serverless environments
- Vercel's serverless functions couldn't resolve the module at runtime

**Attempted Solutions (All Failed):**
1. ‚ùå Nitro config: `externals: { inline: ['jsonwebtoken'] }`
2. ‚ùå Rollup config: `external: []`
3. ‚ùå `traceInclude` configuration
4. ‚ùå `vercel.json` explicit function includes
5. ‚ùå Dynamic imports with `await import('jsonwebtoken')`
6. ‚ùå Multiple esbuild bundler options
7. ‚ùå Various Nitro preset configurations

**Final Solution:** ‚úÖ
Replaced `jsonwebtoken` with `jose` library:

**Why jose works:**
- Pure JavaScript with native ESM support
- Designed specifically for serverless/edge environments
- No bundling issues with Nitro
- Same JWT functionality with modern API

**Files Changed:**
- `server/utils/auth.ts` - JWT verification
- `server/api/auth/login.post.ts` - JWT generation
- `package.json` - Dependency swap

**Code Changes:**

*Before (jsonwebtoken):*
```typescript
import jwt from 'jsonwebtoken'
const token = jwt.sign(payload, secret, { expiresIn: '24h' })
const verified = jwt.verify(token, secret)
```

*After (jose):*
```typescript
import { SignJWT, jwtVerify } from 'jose'

// Generate token
const secret = new TextEncoder().encode(config.jwtSecret)
const token = await new SignJWT(payload)
  .setProtectedHeader({ alg: 'HS256' })
  .setExpirationTime('24h')
  .sign(secret)

// Verify token
const verified = await jwtVerify(token, secret)
const payload = verified.payload
```

---

### Critical Issue #2: Vercel Config File Not Found ‚ö†Ô∏è

**Problem:**
```
Error: Config file was not found at "/vercel/path0/.vercel/output/config.json"
```

**Root Cause:**
- Attempted to manually configure Vercel with `vercel.json`
- Used invalid `framework` value ("nuxt" not in allowed list)
- Specified wrong `outputDirectory` (.output/public instead of .output)
- Committed `.vercel/output` files which should be generated by Vercel

**Solutions Attempted:**

1. **First Attempt:** Created `vercel.json` with framework config
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": ".output/public",
     "framework": "nuxt"  // ‚ùå INVALID
   }
   ```
   **Result:** Schema validation failed

2. **Second Attempt:** Removed invalid framework field
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": ".output/public"  // ‚ùå WRONG PATH
   }
   ```
   **Result:** Config file not found

3. **Third Attempt:** Changed outputDirectory to `.output`
   ```json
   {
     "buildCommand": "npm run build",
     "outputDirectory": ".output"
   }
   ```
   **Result:** Still failed, conflicts with Nitro preset

4. **Fourth Attempt:** Manually created and committed `config.json`
   **Result:** Incomplete build (missing function code)

**Final Solution:** ‚úÖ
- **Removed `vercel.json` entirely**
- Let Nitro's `preset: 'vercel'` handle everything automatically
- Ensured `.vercel` directory is in `.gitignore`
- Vercel builds `.output` directory on their servers during deployment

**Key Lesson:** When using Nitro's Vercel preset, don't override with manual configuration. The preset handles everything.

---

### Issue #3: 404 NOT_FOUND on Deployed URL

**Problem:**
Deployment succeeds but accessing the URL returns 404.

**Possible Causes & Solutions:**

1. **Missing Environment Variables**
   - Check Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
   - Required: `DATABASE_URL`, `JWT_SECRET`
   - Without these, app may fail silently

2. **Wrong URL Format**
   - Build URL (ending in random hash) is not the live site
   - Use actual deployment domain: `yourproject.vercel.app`

3. **Build Failed**
   - Check Vercel build logs for errors
   - Verify `npm run build` succeeds locally

4. **Database Connection Failed**
   - Ensure DATABASE_URL is accessible from Vercel's servers
   - Neon: Enable "Allow connections from anywhere" or whitelist Vercel IPs

---

### Issue #4: Image Upload Size Limits

**Current Implementation:**
- Images converted to Base64 and stored in database
- 2MB limit per image enforced in frontend
- Max 5 images per product

**Considerations:**
- Database row size limit: PostgreSQL ~1GB per row
- 5 images √ó 2MB each = ~10MB max per product (acceptable for MVP)
- For production scale, consider migrating to:
  - Vercel Blob Storage
  - AWS S3
  - Cloudinary
  - imgix

---

### Issue #5: Currency Display

**Problem:** Default implementation used USD ($)

**Solution:**
Updated all currency displays to Philippine Peso (‚Ç±):
- Admin dashboard revenue
- Product pricing displays
- Order totals
- All cart calculations

**Files Updated:**
- `pages/admin/index.vue` (dashboard)
- `pages/admin/products/index.vue` (product list)
- `pages/admin/orders/index.vue` (order list)
- `pages/admin/orders/[id].vue` (order details)

---

## Step-by-Step Deployment

### Phase 1: Database Setup (Neon PostgreSQL)

1. **Create Neon Account**
   - Visit https://neon.tech
   - Sign up with GitHub

2. **Create New Project**
   - Project name: `powell-antique-shop`
   - Region: Choose closest to your target users
   - PostgreSQL version: 15 or later

3. **Get Connection String**
   - Navigate to Dashboard ‚Üí Connection Details
   - Copy the connection string (starts with `postgresql://`)
   - Format: `postgresql://user:password@host/database?sslmode=require`

4. **Configure Neon for External Access**
   - Ensure "Allow connections from anywhere" is enabled
   - Or whitelist Vercel IP ranges

5. **Run Migrations Locally First** (Recommended)
   ```bash
   # Set environment variable
   $env:DATABASE_URL="your-neon-connection-string"
   
   # Push schema to database
   npm run db:push
   
   # Seed initial data (admin user + sample products)
   npm run db:seed
   ```

### Phase 2: GitHub Repository Setup

1. **Initialize Git** (if not done)
   ```powershell
   git init
   git add .
   git commit -m "Initial commit: Powell's Antique Shop MVP"
   ```

2. **Create GitHub Repository**
   - Go to https://github.com/new
   - Repository name: `powellantiqueshop` (or your preference)
   - Visibility: Private (recommended) or Public
   - **Don't** initialize with README

3. **Connect and Push**
   ```powershell
   git remote add origin https://github.com/YOUR_USERNAME/powellantiqueshop.git
   git branch -M master  # or main
   git push -u origin master
   ```

### Phase 3: Vercel Deployment

1. **Import Project to Vercel**
   - Visit https://vercel.com/new
   - Click "Import Git Repository"
   - Authorize GitHub access if needed
   - Select your repository

2. **Configure Project Settings**
   
   Vercel should auto-detect Nuxt, but verify:
   - **Framework Preset:** Nuxt.js (auto-detected)
   - **Root Directory:** `./` (leave default)
   - **Build Command:** `npm run build`
   - **Output Directory:** `.output` (auto-detected)
   - **Install Command:** `npm install`
   - **Node Version:** 18.x or 20.x (recommended)

3. **Add Environment Variables**
   
   Click "Environment Variables" and add these (applies to Production, Preview, Development):

   | Variable Name | Value | Notes |
   |--------------|-------|-------|
   | `DATABASE_URL` | `postgresql://...` | From Neon dashboard |
   | `JWT_SECRET` | (generate strong secret) | See generation command below |
   | `NODE_ENV` | `production` | Optional, Vercel sets automatically |

   **Generate Strong JWT Secret:**
   ```powershell
   # PowerShell
   -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | ForEach-Object {[char]$_})
   ```

   Or use online generator: https://randomkeygen.com/ (use "Fort Knox Password")

4. **Deploy**
   - Click "Deploy"
   - Wait 2-5 minutes for build to complete
   - Vercel will show build logs in real-time

### Phase 4: Post-Deployment Verification

1. **Check Build Logs**
   - Look for "‚úì Build Successful" message
   - Verify no errors in Prisma generation
   - Confirm Nitro preset used: "vercel"

2. **Access Deployed Site**
   - Copy the deployment URL from Vercel dashboard
   - Format: `https://powellantiqueshop.vercel.app`
   - Or custom domain if configured

3. **Test Public Pages**
   - [ ] Homepage loads
   - [ ] Products page displays items
   - [ ] Individual product pages work
   - [ ] Cart functionality
   - [ ] Checkout process

4. **Test Admin Panel**
   - Navigate to `/admin/login`
   - **Default Credentials:**
     - Username: `admin`
     - Password: `admin123`
   - **‚ö†Ô∏è CHANGE IMMEDIATELY AFTER FIRST LOGIN**

5. **Test Admin Features**
   - [ ] Dashboard displays analytics
   - [ ] Create new product with image upload
   - [ ] Edit existing product
   - [ ] Delete product
   - [ ] View orders
   - [ ] Update order status
   - [ ] Manage categories

---

## Environment Variables

### Required Variables

#### `DATABASE_URL`
**Purpose:** PostgreSQL connection string for Prisma

**Format:**
```
postgresql://username:password@host:port/database?sslmode=require
```

**Where to Get:**
- Neon: Dashboard ‚Üí Connection Details
- Supabase: Settings ‚Üí Database ‚Üí Connection String
- Railway: Database ‚Üí Connect tab

**Example:**
```
postgresql://user:pass@ep-cool-name-123456.us-east-2.aws.neon.tech/powelldb?sslmode=require
```

#### `JWT_SECRET`
**Purpose:** Secret key for signing and verifying JWT tokens

**Requirements:**
- Minimum 32 characters
- High entropy (random characters)
- Never expose publicly
- Different for each environment (dev, staging, prod)

**Generate Strong Secret:**
```powershell
# PowerShell
-join ((48..57) + (65..90) + (97..122) | Get-Random -Count 64 | ForEach-Object {[char]$_})
```

```bash
# Linux/Mac
openssl rand -base64 64
```

**Example:**
```
aB3dE7fG9hJ2kL5mN8oP1qR4sT6uV9wX2yZ5aC8bD1eF4gH7iJ0kL3mN6oP9qR2sT5uV8wX1yZ4
```

### Optional Variables

#### `API_BASE_URL`
**Purpose:** Base URL for API calls (only needed if API is separate)

**Default:** `/api` (relative path)

**When to Use:** If you split frontend and backend to different domains

#### `NODE_ENV`
**Purpose:** Environment mode

**Default:** Vercel sets this to `production` automatically

**Possible Values:** `development`, `production`, `test`

---

## Database Setup

### Schema Overview

**Tables:**
1. **Admin** - User authentication
   - id (UUID, primary key)
   - username (unique)
   - email (unique)
   - password (bcrypt hashed)

2. **Category** - Product categorization
   - id (auto-increment)
   - name (unique)
   - slug (unique, URL-safe)
   - description
   - Product[] (one-to-many relationship)

3. **Product** - Inventory items
   - id (auto-increment)
   - name
   - slug (unique)
   - description
   - price (Decimal)
   - quantity (integer)
   - images (JSON array of base64 strings)
   - categoryId (foreign key)
   - featured (boolean)

4. **Order** - Customer purchases
   - id (auto-increment)
   - customerName, email, phone, address
   - total (Decimal)
   - status (enum: PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED)
   - OrderItem[] (one-to-many)

5. **OrderItem** - Individual items in orders
   - id (auto-increment)
   - orderId (foreign key)
   - productId (foreign key, nullable with SET NULL)
   - productName, productPrice (snapshot at purchase time)
   - quantity

### Migration Commands

**Initial Setup:**
```powershell
# Generate Prisma Client
npm run db:generate

# Push schema to database
npm run db:push

# Seed initial data (admin user + sample products)
npm run db:seed
```

**After Schema Changes:**
```powershell
# Create migration
npx prisma migrate dev --name describe_your_changes

# Apply to production
npx prisma migrate deploy
```

**Database Management:**
```powershell
# Open Prisma Studio (database GUI)
npm run db:studio

# Reset database (‚ö†Ô∏è DELETES ALL DATA)
npx prisma migrate reset
```

### Default Admin User

**Created by seed script:**
- Username: `admin`
- Email: `admin@powellsantiques.com`
- Password: `admin123`

**‚ö†Ô∏è CRITICAL SECURITY:**
Change this password immediately after first deployment:
1. Login to `/admin/login`
2. Navigate to admin settings
3. Update password to strong unique value
4. Store securely in password manager

---

## Step-by-Step Deployment

### Prerequisites Checklist
- [ ] Node.js 18+ installed locally
- [ ] PostgreSQL database created (Neon/Supabase)
- [ ] GitHub account
- [ ] Vercel account
- [ ] Database migrations run locally
- [ ] Seed data loaded
- [ ] All tests passing locally

### Deployment Steps

#### 1. Verify Local Build
```powershell
# Clean install
Remove-Item node_modules, .nuxt, .output -Recurse -Force -ErrorAction SilentlyContinue
npm install

# Build for production
npm run build

# Preview locally
npm run preview
```

Expected output:
- ‚úÖ Prisma Client generated
- ‚úÖ Nuxt build successful
- ‚úÖ Nitro preset: vercel
- ‚úÖ `.output` directory created

#### 2. Push to GitHub
```powershell
# Stage all changes
git add .

# Commit
git commit -m "Ready for production deployment"

# Push to remote
git push origin master
```

#### 3. Deploy to Vercel

**Option A: Vercel Dashboard (Recommended)**
1. Go to https://vercel.com/new
2. Import your GitHub repository
3. Configure environment variables (see Environment Variables section)
4. Click "Deploy"

**Option B: Vercel CLI**
```powershell
# Install Vercel CLI
npm install -g vercel

# Login
vercel login

# Deploy
vercel --prod
```

#### 4. Monitor Deployment
- Watch build logs in Vercel dashboard
- Build time: typically 2-5 minutes
- Look for these key milestones:
  - ‚úÖ Installing dependencies
  - ‚úÖ Running `prisma generate`
  - ‚úÖ Building Nuxt client
  - ‚úÖ Building Nitro server
  - ‚úÖ Deployment ready

#### 5. Configure Domain (Optional)
1. Vercel Dashboard ‚Üí Project ‚Üí Settings ‚Üí Domains
2. Add your custom domain
3. Update DNS records as instructed
4. Wait for SSL provisioning (automatic)

---

## Post-Deployment Checklist

### Security & Configuration

- [ ] **Change default admin password**
  - Login at `/admin/login` with `admin` / `admin123`
  - Update to strong password immediately
  
- [ ] **Verify JWT_SECRET**
  - Check Vercel environment variables
  - Ensure it's a strong random string (64+ characters)
  - Never use weak values like "secret" or "test"

- [ ] **Test Authentication**
  - Login to admin panel
  - Verify JWT token is set (check cookies in browser DevTools)
  - Logout and verify token is cleared
  - Test protected routes

- [ ] **Database Connection**
  - Verify Neon allows Vercel connections
  - Test API endpoints that query database
  - Check Neon dashboard for connection activity

- [ ] **HTTPS Enforcement**
  - Verify all pages load over HTTPS
  - Check secure cookie flag is working
  - Test that HTTP redirects to HTTPS

### Functionality Testing

**Public User Flow:**
- [ ] Browse products page
- [ ] View individual product details
- [ ] Add product to cart
- [ ] Update cart quantities
- [ ] Remove items from cart
- [ ] Proceed to checkout
- [ ] Submit order with contact info
- [ ] Verify order confirmation

**Admin User Flow:**
- [ ] Login to admin panel
- [ ] View dashboard analytics (orders, revenue, products)
- [ ] Create new product
  - Upload images (test 2MB limit)
  - Set pricing and inventory
  - Assign to category
- [ ] Edit existing product
  - Update details
  - Change images
  - Modify inventory
- [ ] Delete product (verify cascade behavior)
- [ ] View orders list
- [ ] Filter orders by status
- [ ] View order details
- [ ] Update order status
- [ ] Manage categories
  - Create category
  - Edit category
  - Delete category (verify product count validation)

### Performance & Monitoring

- [ ] **Page Load Speed**
  - Homepage < 2 seconds
  - Product pages < 1.5 seconds
  - Admin panel < 2 seconds

- [ ] **API Response Times**
  - Product listing < 500ms
  - Order creation < 1 second
  - Image upload < 2 seconds

- [ ] **Error Monitoring**
  - Set up Vercel error tracking
  - Monitor function logs for exceptions
  - Check database query performance

- [ ] **Database Size**
  - Monitor Neon storage usage
  - Plan for base64 image storage growth
  - Consider cleanup strategy for old orders

---

## Troubleshooting

### Build Fails on Vercel

**Symptom:** Red "Failed" status in deployments

**Check:**
1. View build logs in Vercel deployment page
2. Look for the specific error message

**Common Causes:**

#### Error: "Module not found"
```
Cannot find module 'xyz'
```
**Solution:** 
- Ensure package is in `dependencies`, not `devDependencies`
- Run `npm install xyz --save` locally
- Commit `package.json` and `package-lock.json`

#### Error: "Prisma Client not generated"
```
PrismaClient is unable to run in an edge environment
```
**Solution:**
- Verify `postinstall` script exists: `"postinstall": "prisma generate"`
- Check DATABASE_URL is set in Vercel environment variables

#### Error: "Build command failed"
```
Command "npm run build" exited with 1
```
**Solution:**
- Run `npm run build` locally to see the error
- Fix TypeScript errors
- Check all imports are valid
- Verify all environment variables are available

### Deployment Succeeds but Site Shows 404

**Symptom:** Build succeeds, but visiting URL shows `404: NOT_FOUND`

**Solutions:**

1. **Check Environment Variables**
   ```
   Vercel Dashboard ‚Üí Your Project ‚Üí Settings ‚Üí Environment Variables
   ```
   - Ensure `DATABASE_URL` is set
   - Ensure `JWT_SECRET` is set
   - Click "Redeploy" after adding variables

2. **Check Correct URL**
   - Don't use the build URL (has random hash)
   - Use: `https://yourproject.vercel.app`
   - Or your custom domain

3. **Check Function Logs**
   ```
   Vercel Dashboard ‚Üí Your Project ‚Üí Deployments ‚Üí [Latest] ‚Üí Functions
   ```
   - Look for runtime errors
   - Check if serverless function is crashing

4. **Verify Routing Configuration**
   - Nuxt should handle all routes via `__fallback` function
   - Check `.output` was generated during build
   - Verify no `vercel.json` is overriding defaults

### Authentication Issues

**Symptom:** Can't login to admin panel

**Solutions:**

1. **Check JWT_SECRET**
   - Verify it's set in Vercel environment variables
   - Must be the same value used when generating tokens
   - Redeploy after adding/changing

2. **Check Admin User Exists**
   - Verify `db:seed` was run on production database
   - Or manually create admin user in Prisma Studio

3. **Check Cookie Settings**
   - Cookies must be `httpOnly`, `secure: true` in production
   - Browser must support cookies
   - Check browser DevTools ‚Üí Application ‚Üí Cookies

4. **Check CORS**
   - If frontend/backend on different domains
   - Add CORS headers in Nitro config

### Database Connection Fails

**Symptom:** API errors: "Can't reach database server"

**Solutions:**

1. **Check CONNECTION String Format**
   ```
   postgresql://user:password@host:port/database?sslmode=require
   ```
   - Ensure `?sslmode=require` is included
   - Check no spaces or newlines in string

2. **Check Neon IP Allowlist**
   - Neon Dashboard ‚Üí Settings ‚Üí IP Allow
   - Either enable "Allow all" or whitelist Vercel IPs
   - Vercel IPs: https://vercel.com/docs/concepts/edge-network/regions

3. **Check Database is Active**
   - Neon auto-suspends idle databases
   - First query may take 1-2 seconds to wake up
   - Consider Neon paid plan for always-on

4. **Check Prisma Client Version**
   - Ensure Prisma Client is generated during build
   - Check `postinstall` script runs: `"postinstall": "prisma generate"`

### Image Upload Issues

**Symptom:** Image upload fails or returns error

**Solutions:**

1. **Check File Size**
   - Max 2MB per image enforced in frontend
   - Browser shows alert if exceeded
   - Update limit in product form components if needed

2. **Check Database Field Size**
   - Prisma schema: `images Json`
   - PostgreSQL can handle large JSON
   - But total row size limit is ~1GB

3. **Base64 Conversion Errors**
   - Ensure FileReader API is supported (modern browsers)
   - Check browser console for JavaScript errors
   - Verify file is valid image format (jpg, png, webp)

### Order Creation Fails

**Symptom:** Checkout completes but order doesn't save

**Solutions:**

1. **Check Validation**
   - All fields required: name, email, phone, address
   - Cart must not be empty
   - Products must have sufficient inventory

2. **Check Database Transaction**
   - View Vercel function logs for Prisma errors
   - Verify foreign key constraints aren't violated
   - Check product IDs exist

3. **Check Inventory Deduction**
   - Product quantity decremented after order
   - May fail if insufficient stock
   - Check concurrent order handling

---

## Architecture Details

### Request Flow

```
User Request (e.g., GET /products)
    ‚Üì
Vercel Edge Network (CDN)
    ‚Üì
Nuxt SSR (Server-Side Rendering)
    ‚Üì
Nitro Server (API Handler if /api/*)
    ‚Üì
Prisma ORM (Database query)
    ‚Üì
Neon PostgreSQL (Data storage)
    ‚Üì
Response rendered and returned
    ‚Üì
User Browser
```

### API Endpoint Structure

All API endpoints are in `server/api/` directory:

**Public Endpoints:**
- `GET /api/products` - List all products (with pagination, filtering)
- `GET /api/products/:id` - Get single product details
- `GET /api/categories` - List all categories
- `POST /api/orders` - Create new order (checkout)

**Protected Endpoints** (require JWT token):
- `POST /api/auth/login` - Admin login
- `POST /api/auth/logout` - Admin logout
- `GET /api/admin/products` - List products (admin view)
- `POST /api/admin/products` - Create product
- `PUT /api/admin/products/:id` - Update product
- `DELETE /api/admin/products/:id` - Delete product
- `GET /api/admin/orders` - List all orders
- `GET /api/admin/orders/:id` - Get order details
- `PUT /api/admin/orders/:id/status` - Update order status
- `GET /api/admin/dashboard` - Dashboard analytics
- `GET/POST/PUT/DELETE /api/admin/categories/*` - Category management

### Authentication Flow

```
1. Admin visits /admin/login
2. Enters username + password
3. POST /api/auth/login
   - Validates credentials
   - Hashes password with bcrypt
   - Compares with stored hash
4. If valid:
   - Generates JWT with jose (payload: id, username, email)
   - Sets HTTP-only cookie (secure: true in production)
   - Returns success response
5. Subsequent requests:
   - Middleware checks cookie
   - Verifies JWT with jose
   - Extracts user info from payload
   - Allows/denies access
6. Logout:
   - POST /api/auth/logout
   - Clears HTTP-only cookie
   - Redirects to login
```

### File Upload Flow

```
1. User selects image file (via <input type="file">)
2. Frontend validates:
   - File type (image/jpeg, image/png, image/webp)
   - File size (< 2MB)
3. Convert to Base64:
   - FileReader.readAsDataURL()
   - Returns data:image/jpeg;base64,/9j/4AAQ...
4. Store in product object:
   - images: string[] array
   - Max 5 images per product
5. Submit to API:
   - POST /api/admin/products (create)
   - PUT /api/admin/products/:id (update)
6. Backend validation (Zod schema)
7. Save to database (Prisma):
   - images field is Json type
   - Stores entire base64 string array
8. Retrieval:
   - Query product
   - Return images array
   - Frontend displays: <img :src="image" />
```

### State Management (Pinia)

**Cart Store** (`stores/cart.ts`):
- Persists to localStorage
- Actions: addToCart, removeFromCart, updateQuantity, clearCart
- Getters: cartItems, cartTotal, cartCount

**Usage:**
```typescript
import { useCartStore } from '~/stores/cart'
const cart = useCartStore()
cart.addToCart(product)
```

---

## Critical Files Reference

### Configuration Files

#### `nuxt.config.ts`
**Purpose:** Main Nuxt configuration

**Key Settings:**
```typescript
{
  modules: ['@nuxtjs/tailwindcss', '@nuxt/image', '@pinia/nuxt'],
  runtimeConfig: {
    databaseUrl: process.env.DATABASE_URL,
    jwtSecret: process.env.JWT_SECRET,
  },
  nitro: {
    preset: 'vercel'  // CRITICAL: Enables Vercel deployment
  }
}
```

#### `package.json`
**Purpose:** Dependencies and build scripts

**Critical Scripts:**
```json
{
  "build": "prisma generate && nuxt build",
  "postinstall": "prisma generate"  // Runs on Vercel
}
```

**Critical Dependencies:**
- `jose: ^5.2.3` - JWT (not jsonwebtoken!)
- `@prisma/client: ^5.18.0`
- `nuxt: ^3.12.4`

#### `prisma/schema.prisma`
**Purpose:** Database schema definition

**Important Settings:**
```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}
```

#### `.gitignore`
**Purpose:** Exclude files from version control

**Critical Exclusions:**
```
.env           # Secrets
.output        # Build output (Vercel generates this)
.vercel        # Vercel build cache
node_modules   # Dependencies
```

### Authentication Files

#### `server/utils/auth.ts`
**Purpose:** JWT verification middleware for protected routes

**Key Function:**
```typescript
export async function requireAuth(event: H3Event) {
  const token = getCookie(event, 'token')
  if (!token) throw createError({ statusCode: 401 })
  
  const secret = new TextEncoder().encode(config.jwtSecret)
  const verified = await jwtVerify(token, secret)
  return verified.payload as { id: string; username: string; email: string }
}
```

**Used in:** All `/api/admin/*` endpoints

#### `server/api/auth/login.post.ts`
**Purpose:** Admin login endpoint that generates JWT

**Flow:**
1. Validate request body (Zod)
2. Find admin by username
3. Compare password hash (bcrypt)
4. Generate JWT token (jose)
5. Set HTTP-only cookie
6. Return user info (without password)

---

## Known Limitations & Future Enhancements

### Current Limitations (MVP)

1. **Image Storage**
   - Using Base64 in database (2MB per image, max 5 images/product)
   - Works for MVP but not ideal for high-scale
   - Database bloat possible with many products

2. **No Email Notifications**
   - Order confirmations not sent
   - Admin doesn't get order alerts

3. **Payment Not Integrated**
   - Checkout collects info but doesn't process payment
   - Ready for integration with Stripe, PayPal, etc.

4. **No Rate Limiting**
   - API endpoints unprotected from abuse
   - Could be DoS vulnerable

5. **Simple Error Messages**
   - Using browser `alert()` for notifications
   - Not production-quality UX

6. **Single Admin User**
   - No multi-admin support
   - No role-based access control
   - No admin audit logs

### Recommended Enhancements

#### Short Term (Pre-Production)
1. **Switch to Cloud Image Storage**
   - Use Vercel Blob, AWS S3, or Cloudinary
   - Update schema to store URLs instead of Base64
   - Implement signed URLs for security

2. **Add Toast Notifications**
   - Replace `alert()` with proper UI library
   - Consider: nuxt-toast, vue-toastification

3. **Implement Rate Limiting**
   - Add Vercel rate limiting
   - Or use middleware with Redis

4. **Add Email Service**
   - Integrate SendGrid, Mailgun, or Resend
   - Send order confirmations
   - Admin notifications

#### Long Term (Post-Launch)
1. **Payment Integration**
   - Stripe or PayPal
   - Handle webhooks for order status
   - Secure payment form

2. **Multi-Admin Support**
   - Role-based access (super-admin, editor, viewer)
   - Audit logs
   - Activity tracking

3. **Analytics**
   - Google Analytics or Plausible
   - Track conversions
   - Monitor user behavior

4. **Search Functionality**
   - Product search with Algolia or Meilisearch
   - Filters by price, category, availability

5. **Customer Accounts**
   - User registration/login
   - Order history
   - Saved addresses

---

## Performance Optimization

### Current Optimizations

1. **Server-Side Rendering (SSR)**
   - Faster first contentful paint
   - SEO-friendly
   - Dynamic content rendering

2. **Image Optimization**
   - `@nuxt/image` module configured
   - WebP format support
   - Quality: 80% (balance size/quality)

3. **Code Splitting**
   - Vite automatic chunk splitting
   - Lazy loading for routes
   - Smaller initial bundle

4. **Vercel Edge Network**
   - Global CDN
   - Automatic caching
   - Edge functions close to users

### Recommended Optimizations

1. **Add Caching Headers**
   ```typescript
   // In nitro config
   nitro: {
     preset: 'vercel',
     routeRules: {
       '/api/products': { swr: 60 },  // Cache 60s
       '/api/categories': { swr: 300 }, // Cache 5min
     }
   }
   ```

2. **Database Query Optimization**
   - Add indexes on frequently queried fields
   - Use Prisma select to limit returned fields
   - Implement pagination on large lists

3. **Image CDN**
   - Move images to Vercel Blob or Cloudinary
   - Automatic optimization
   - Responsive images

---

## Security Best Practices

### Implemented Security Measures

1. **Password Security**
   - Bcrypt hashing with 10 rounds
   - Never stored in plain text
   - Salted automatically by bcrypt

2. **JWT Token Security**
   - HTTP-only cookies (not accessible via JavaScript)
   - Secure flag in production (HTTPS only)
   - 24-hour expiration
   - Strong secret key required

3. **Input Validation**
   - Zod schemas on all API endpoints
   - Type checking with TypeScript
   - Prevents SQL injection (Prisma parameterized queries)

4. **Authentication Middleware**
   - All `/api/admin/*` routes protected
   - Token verification on every request
   - User context extracted from JWT

5. **Environment Variables**
   - Secrets in `.env` (never committed)
   - Different secrets per environment
   - Vercel encrypts environment variables

### Additional Security Recommendations

1. **Add CORS Configuration**
   ```typescript
   // nuxt.config.ts
   nitro: {
     preset: 'vercel',
     routeRules: {
       '/api/**': {
         cors: true,
         headers: {
           'Access-Control-Allow-Origin': 'your-domain.com',
           'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE',
         }
       }
     }
   }
   ```

2. **Implement Rate Limiting**
   - Prevent brute force login attacks
   - Limit API requests per IP
   - Use Vercel Edge Config or Upstash Redis

3. **Add CSRF Protection**
   - For state-changing operations
   - Use double-submit cookie pattern
   - Or synchronizer token pattern

4. **Sanitize User Input**
   - Escape HTML in user-generated content
   - Prevent XSS attacks
   - Use DOMPurify or similar

5. **Enable Content Security Policy**
   ```typescript
   // nuxt.config.ts
   app: {
     head: {
       meta: [
         {
           'http-equiv': 'Content-Security-Policy',
           content: "default-src 'self'; script-src 'self' 'unsafe-inline'"
         }
       ]
     }
   }
   ```

6. **Regular Dependency Updates**
   ```powershell
   # Check for vulnerabilities
   npm audit
   
   # Fix automatically
   npm audit fix
   
   # Update dependencies
   npm update
   ```

---

## Monitoring & Maintenance

### Vercel Dashboard Monitoring

1. **Deployment Status**
   - View all deployments
   - Monitor build times
   - Check success/failure rates

2. **Function Logs**
   - Real-time serverless function logs
   - Filter by time, status code
   - Search for errors

3. **Analytics**
   - Page views
   - Top pages
   - Geographic distribution
   - Bandwidth usage

4. **Performance Insights**
   - Real User Monitoring (RUM)
   - Core Web Vitals
   - Function execution time

### Database Monitoring (Neon)

1. **Connection Pooling**
   - Monitor active connections
   - Check connection limits
   - Adjust pooling if needed

2. **Query Performance**
   - Slow query log
   - Query statistics
   - Optimize with indexes

3. **Storage Usage**
   - Monitor database size growth
   - Plan for base64 image storage
   - Set up alerts for thresholds

4. **Backups**
   - Neon auto-backups (check retention)
   - Consider manual backups before major changes
   - Test restore process

### Error Tracking

**Set Up Sentry (Recommended):**
```powershell
npm install @sentry/nuxt
```

**Configure:**
```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  modules: ['@sentry/nuxt/module'],
  sentry: {
    dsn: process.env.SENTRY_DSN,
  }
})
```

---

## Rollback Procedures

### Rollback Vercel Deployment

1. **Via Dashboard:**
   - Go to Deployments tab
   - Find previous working deployment
   - Click three dots (‚ãÆ)
   - Select "Promote to Production"

2. **Via CLI:**
   ```powershell
   vercel rollback [deployment-url]
   ```

### Rollback Database Migration

```powershell
# Reset to specific migration
npx prisma migrate resolve --rolled-back [migration-name]

# Reset entire database (‚ö†Ô∏è DELETES DATA)
npx prisma migrate reset
```

**Best Practice:** Always backup database before migrations

---

## Common Commands Reference

### Development
```powershell
# Start dev server
npm run dev

# Build for production
npm run build

# Preview production build locally
npm run preview
```

### Database
```powershell
# Generate Prisma Client
npm run db:generate

# Push schema changes (dev)
npm run db:push

# Create migration (production-ready)
npx prisma migrate dev --name your_migration_name

# Apply migrations (production)
npx prisma migrate deploy

# Open database GUI
npm run db:studio

# Seed database
npm run db:seed
```

### Deployment
```powershell
# Install Vercel CLI
npm install -g vercel

# Login
vercel login

# Deploy to preview
vercel

# Deploy to production
vercel --prod

# View logs
vercel logs [deployment-url]
```

### Testing
```powershell
# Lint code
npm run lint

# Type check
npx nuxi typecheck

# Test build locally
npm run build && npm run preview
```

---

## Contact & Support

### Documentation References
- **Nuxt 3:** https://nuxt.com/docs
- **Nitro:** https://nitro.unjs.io
- **Prisma:** https://www.prisma.io/docs
- **Vercel:** https://vercel.com/docs
- **Neon:** https://neon.tech/docs
- **jose Library:** https://github.com/panva/jose

### Project Files
- API Documentation: `API_DOCUMENTATION.md`
- Architecture Details: `ARCHITECTURE.md`
- Production Readiness: `PRODUCTION_READINESS.md`
- Quick Start: `QUICKSTART.md`

---

## Deployment Checklist Summary

### Pre-Deployment
- [ ] All features tested locally
- [ ] `npm run build` succeeds
- [ ] Environment variables documented
- [ ] Database migrations ready
- [ ] Security audit completed
- [ ] `.gitignore` properly configured

### Deployment
- [ ] GitHub repository created and pushed
- [ ] Vercel project imported
- [ ] Environment variables added in Vercel
- [ ] Database accessible from Vercel
- [ ] Build succeeds on Vercel
- [ ] Deployment URL accessible

### Post-Deployment
- [ ] Change default admin password
- [ ] Generate and set strong JWT_SECRET
- [ ] Test all critical user flows
- [ ] Monitor error logs for 24 hours
- [ ] Set up error tracking (Sentry)
- [ ] Configure custom domain (if applicable)
- [ ] Enable Vercel analytics
- [ ] Document any deployment-specific issues

---

## Critical Lessons Learned

### 1. Library Compatibility Matters
**Issue:** CommonJS libraries (jsonwebtoken) don't work in ESM serverless environments

**Solution:** Always use ESM-native libraries for Vercel/Nitro deployments
- ‚úÖ jose (ESM)
- ‚ùå jsonwebtoken (CommonJS)

**How to Check:**
- Look for `"type": "module"` in library's package.json
- Check if library has `.mjs` exports
- Test build locally before deploying

### 2. Don't Override Framework Presets
**Issue:** Manual `vercel.json` configuration conflicted with Nitro preset

**Solution:** Trust framework defaults
- Nitro's `preset: 'vercel'` handles everything
- No need for manual `vercel.json`
- Don't commit `.output` or `.vercel` directories

### 3. Serverless Requires Different Thinking
**Key Differences from Traditional Servers:**
- No persistent file system (use cloud storage)
- No long-running processes (use background jobs/queues)
- Cold starts (optimize bundle size)
- Module bundling quirks (prefer ESM)

### 4. Environment Variables are Critical
**Must be set before deployment:**
- Database connection strings
- API secrets (JWT_SECRET)
- Third-party API keys

**Vercel doesn't fail loudly if they're missing** - app just doesn't work

### 5. Build Output Must Match Vercel Expectations
- Nitro generates `.output` directory
- Contains `config.json` and serverless functions
- Must not be committed to git
- Vercel regenerates on every deploy

---

**Last Updated:** January 29, 2026
**Project Status:** Ready for production deployment
**Deployment Platform:** Vercel (Serverless)
**Database:** Neon PostgreSQL (Serverless)
